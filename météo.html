<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Manifest PWA -->
<link rel="manifest" href="manifest.json">

<!-- Couleur du th√®me (barre d'adresse sur mobile) -->
<meta name="theme-color" content="#009900">

<!-- Apple Touch Icons pour iOS -->
<link rel="apple-touch-icon" href="images/icon-152x152.png">
<link rel="apple-touch-icon" sizes="72x72" href="images/icon-72x72.png">
<link rel="apple-touch-icon" sizes="96x96" href="images/icon-96x96.png">
<link rel="apple-touch-icon" sizes="128x128" href="images/icon-128x128.png">
<link rel="apple-touch-icon" sizes="144x144" href="images/icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="images/icon-152x152.png">
<link rel="apple-touch-icon" sizes="192x192" href="images/icon-192x192.png">
<link rel="apple-touch-icon" sizes="384x384" href="images/icon-384x384.png">
<link rel="apple-touch-icon" sizes="512x512" href="images/icon-512x512.png">

<!-- Configuration iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KOP SUD ASSE">

<!-- Configuration Windows -->
<meta name="msapplication-TileImage" content="images/icon-144x144.png">
<meta name="msapplication-TileColor" content="#009900">

<!-- Description pour SEO et partage -->
<meta name="description" content="Application officielle du Kop Sud de l'AS Saint-√âtienne - Green Angels 92. Suivez les matchs, les chants et rejoignez la communaut√© des supporters st√©phanois !">
    <title>KOP SUD ASSE - M√©t√©o du Chaudron</title>
    <link rel="stylesheet" href="css/style.css"> 
</head>
<body>

    <header>
        <nav id="main-nav">
            <a href="index.html" class="nav-logo">KOP SUD | Green Angels 92</a>
            <ul>
                <li><a href="index.html" class="nav-button">Accueil</a></li>
                <li><a href="photos.html" class="nav-button">Vos Photos</a></li>
                <li><a href="chant.html" class="nav-button">Chants</a></li>
                <li><a href="calendrier.html" class="nav-button">Matchs & Compte √† Rebours</a></li>
                <li><a href="m√©t√©o.html" class="nav-button">M√©t√©o du Chaudron</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-content">
        <h1 class="page-title" style="text-align: center;">M√©t√©o du Chaudron</h1>

        <div class="meteo-hero">
            <h2>üèüÔ∏è Stade Geoffroy-Guichard</h2>
            <p>üìç Saint-√âtienne, Loire (42)</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Pr√©parez votre vir√©e au stade avec la m√©t√©o en temps r√©el !</p>
            <div style="margin-top: 20px;">
                <button id="refreshBtn" onclick="manualRefresh()" style="background-color: var(--texte-clair); color: var(--couleur-primaire); border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1em; transition: all 0.3s;">
                    üîÑ Actualiser
                </button>
                <p id="lastRefresh" style="font-size: 0.85em; margin-top: 10px; opacity: 0.9;">Derni√®re mise √† jour : Chargement...</p>
            </div>
        </div>

        <div id="meteoContent" class="loading">
            Chargement de la m√©t√©o... ‚è≥
        </div>

        <div class="match-meteo-section">
            <div class="match-meteo-header">
                <h2>‚öΩ M√âT√âO DU PROCHAIN MATCH</h2>
                <p style="font-size: 1.1em;">Samedi 22 Novembre 2025 - 20h00</p>
            </div>

            <div class="match-info">
                <div class="team-info">
                    <img src="images/ASSE.png" alt="ASSE">
                    <div style="font-weight: bold; font-size: 1.2em;">AS SAINT-√âTIENNE</div>
                </div>
                <div class="vs">VS</div>
                <div class="team-info">
                    <img src="images/nancy.png" alt="Nancy">
                    <div style="font-weight: bold; font-size: 1.2em;">AS NANCY</div>
                </div>
            </div>

            <div class="match-meteo-details" id="matchMeteoDetails">
                <div class="match-detail-card">
                    <div class="match-detail-icon">üå°Ô∏è</div>
                    <div class="match-detail-value" id="matchTemp">--¬∞C</div>
                    <div class="match-detail-label">Temp√©rature</div>
                </div>
                <div class="match-detail-card">
                    <div class="match-detail-icon">‚òÅÔ∏è</div>
                    <div class="match-detail-value" id="matchCondition">Chargement...</div>
                    <div class="match-detail-label">Conditions</div>
                </div>
                <div class="match-detail-card">
                    <div class="match-detail-icon">üí®</div>
                    <div class="match-detail-value" id="matchWind">-- km/h</div>
                    <div class="match-detail-label">Vent</div>
                </div>
                <div class="match-detail-card">
                    <div class="match-detail-icon">üíß</div>
                    <div class="match-detail-value" id="matchRain">--%</div>
                    <div class="match-detail-label">Pluie</div>
                </div>
            </div>

            <div class="meteo-advice">
                <h3>üíö Conseils pour le match</h3>
                <ul id="adviceList">
                    <li>Chargement des conseils...</li>
                </ul>
            </div>
        </div>
    </main>
    
    <footer>
        <p>¬© 2025 Kop Sud ASSE - R√©alis√© par un fervent supporter. PARTIZANS D'UN JOUR, PARTIZANS POUR TOUJOURS !</p>
    </footer>

    <script>
        // Constantes de localisation et de match
        const ST_ETIENNE_LAT = 45.4608;
        const ST_ETIENNE_LON = 4.3900;
        const MATCH_DATE = '2025-11-22'; // Format AAAA-MM-JJ pour la recherche
        
        // Variable pour stocker l'heure de la derni√®re mise √† jour
        let lastRefreshTime = new Date();

        // Fonction pour r√©cup√©rer la m√©t√©o
        async function fetchWeather() {
            try {
                // Requ√™te API avec les donn√©es actuelles et les pr√©visions sur 7 jours (inclut vent max et probabilit√© de pr√©cipitation max)
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${ST_ETIENNE_LAT}&longitude=${ST_ETIENNE_LON}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,wind_speed_10m_max,precipitation_probability_max&timezone=Europe/Paris&forecast_days=7`
                );
                
                const data = await response.json();
                displayWeather(data);
                updateMatchWeather(data); // Appel pour la m√©t√©o du match avec la recherche dynamique
                
                // Mise √† jour de l'heure de derni√®re actualisation
                lastRefreshTime = new Date();
                updateLastRefreshTime();
                
            } catch (error) {
                console.error("Erreur lors du chargement de la m√©t√©o:", error);
                document.getElementById('meteoContent').innerHTML = `
                    <div class="meteo-card">
                        <p style="color: red;">‚ùå Impossible de charger la m√©t√©o. Veuillez r√©essayer plus tard.</p>
                    </div>
                `;
            }
        }

        // Fonctions de traduction des codes m√©t√©o (WMO Weather interpretation codes)
        function getWeatherIcon(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return 'üå®Ô∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return 'üå®Ô∏è';
            return '‚õàÔ∏è';
        }

        function getWeatherText(code) {
            if (code === 0) return 'Ensoleill√©';
            if (code <= 3) return 'Partiellement nuageux';
            if (code <= 48) return 'Brouillard';
            if (code <= 67) return 'Pluvieux';
            if (code <= 77) return 'Neigeux';
            if (code <= 82) return 'Averses';
            if (code <= 86) return 'Neige';
            return 'Orageux';
        }

        // Affiche la m√©t√©o actuelle et la pr√©vision sur 7 jours
        function displayWeather(data) {
            const current = data.current;
            const daily = data.daily;
            
            const html = `
                <div class="meteo-container">
                    <div class="meteo-card meteo-current">
                        <h2 style="color: var(--couleur-primaire);">M√©t√©o Actuelle</h2>
                        <div class="weather-icon">${getWeatherIcon(current.weather_code)}</div>
                        <div class="temperature">${Math.round(current.temperature_2m)}¬∞C</div>
                        <p style="font-size: 1.2em; color: var(--couleur-secondaire);">${getWeatherText(current.weather_code)}</p>
                        
                        <div class="weather-details">
                            <div class="detail-item">
                                <div class="detail-label">üí® Vent</div>
                                <div class="detail-value">${Math.round(current.wind_speed_10m)} km/h</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">üíß Humidit√©</div>
                                <div class="detail-value">${current.relative_humidity_2m}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">üìÖ Aujourd'hui</div>
                                <div class="detail-value">${new Date().toLocaleDateString('fr-FR')}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h2 style="text-align: center; color: var(--couleur-primaire); margin: 40px 0 20px 0;">Pr√©visions sur 7 jours</h2>
                <div class="forecast-container">
                    ${daily.time.map((date, index) => {
                        const dayName = new Date(date).toLocaleDateString('fr-FR', { weekday: 'short' });
                        return `
                            <div class="forecast-day">
                                <div class="forecast-day-name">${dayName}</div>
                                <div class="forecast-icon">${getWeatherIcon(daily.weather_code[index])}</div>
                                <div class="forecast-temp">
                                    <span style="color: var(--couleur-primaire);">${Math.round(daily.temperature_2m_max[index])}¬∞</span>
                                    / 
                                    <span style="color: #666;">${Math.round(daily.temperature_2m_min[index])}¬∞</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('meteoContent').innerHTML = html;
        }

        /**
         * Calcule l'index du jour du match de mani√®re dynamique.
         */
        function updateMatchWeather(data) {
            // Recherche dynamique de l'index de la date du match (MATCH_DATE) dans le tableau 'time' de l'API
            const matchDayIndex = data.daily.time.findIndex(date => date === MATCH_DATE);
            
            const adviceList = document.getElementById('adviceList');
            
            // V√©rifie si le match est dans les 7 jours de pr√©visions (l'index sera >= 0)
            if (matchDayIndex !== -1) {
                const dailyData = data.daily;
                
                // R√©cup√©ration des donn√©es sp√©cifiques pour ce jour
                const tempMax = dailyData.temperature_2m_max[matchDayIndex];
                const weatherCode = dailyData.weather_code[matchDayIndex];
                const windSpeed = dailyData.wind_speed_10m_max[matchDayIndex];
                const rainProb = dailyData.precipitation_probability_max[matchDayIndex];
                
                // Mise √† jour de l'affichage
                document.getElementById('matchTemp').textContent = Math.round(tempMax) + '¬∞C';
                document.getElementById('matchCondition').textContent = getWeatherText(weatherCode);
                document.getElementById('matchWind').textContent = Math.round(windSpeed) + ' km/h';
                document.getElementById('matchRain').textContent = Math.round(rainProb) + '%';
                
                // Conseils en fonction de la m√©t√©o
                let advice = '';
                
                if (tempMax < 10) {
                    advice += '<li>ü•∂ Temp√©rature fra√Æche : pr√©voyez des v√™tements chauds et une √©charpe ASSE !</li>';
                } else if (tempMax > 20) {
                    advice += '<li>‚òÄÔ∏è Temp√©rature agr√©able : une tenue l√©g√®re suffira pour sauter !</li>';
                } else {
                    advice += '<li>üß• Pr√©voyez une veste l√©g√®re, le Chaudron vous r√©chauffera !</li>';
                }
                
                if (rainProb > 40) {
                    advice += '<li>‚ö†Ô∏è Risque de pluie √©lev√© : pensez √† prendre un imperm√©able ou un K-Way !</li>';
                } else if (rainProb > 0) {
                    advice += '<li>üåßÔ∏è Quelques averses possibles : gardez un ≈ìil sur le ciel !</li>';
                }
                
                advice += '<li>Arrivez 30 minutes avant le coup d\'envoi pour profiter de l\'ambiance.</li>';
                advice += '<li>√âchauffez vos cordes vocales, la Snella va vibrer ! üíö</li>';
                
                adviceList.innerHTML = advice;

            } else {
                // Si le match n'est pas dans les 7 jours de pr√©visions
                adviceList.innerHTML = `<li>Le match est trop loin pour des pr√©visions pr√©cises (l'API fournit 7 jours). Revenez plus tard !</li>`;
                document.getElementById('matchTemp').textContent = 'N/A';
                document.getElementById('matchCondition').textContent = 'Hors Pr√©visions';
                document.getElementById('matchWind').textContent = 'N/A';
                document.getElementById('matchRain').textContent = 'N/A';
            }
        }

        // Afficher l'heure de la derni√®re mise √† jour
        function updateLastRefreshTime() {
            const now = new Date();
            const diff = Math.floor((now - lastRefreshTime) / 60000); // Diff√©rence en minutes
            
            let refreshText = '';
            if (diff === 0) {
                refreshText = '√Ä l\'instant';
            } else if (diff === 1) {
                refreshText = 'Il y a 1 minute';
            } else if (diff < 60) {
                refreshText = `Il y a ${diff} minutes`;
            } else {
                refreshText = lastRefreshTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
            
            const refreshDiv = document.getElementById('lastRefresh');
            if (refreshDiv) {
                refreshDiv.textContent = `Derni√®re mise √† jour : ${refreshText}`;
            }
        }

        // Bouton de rafra√Æchissement manuel
        function manualRefresh() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'üîÑ Actualisation...';
            
            fetchWeather().then(() => {
                lastRefreshTime = new Date();
                updateLastRefreshTime();
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Actualiser';
            });
        }

        // Charger la m√©t√©o au chargement de la page et mise √† jour automatique
        window.addEventListener('DOMContentLoaded', () => {
            fetchWeather();
            
            // Mise √† jour automatique toutes les 10 minutes (600000 ms)
            setInterval(fetchWeather, 600000);
            
            // Afficher l'heure de la derni√®re mise √† jour
            setInterval(updateLastRefreshTime, 60000); 
        });
    </script>
<script>
// ===== ENREGISTREMENT DU SERVICE WORKER =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/Kop_Sud/service-worker.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker enregistr√© avec succ√®s:', registration.scope);
      })
      .catch((error) => {
        console.log('‚ùå √âchec de l\'enregistrement du Service Worker:', error);
      });
  });
}

// ===== BOUTON D'INSTALLATION PWA =====
let deferredPrompt;
const installButton = document.createElement('button');
installButton.id = 'installPWA';
installButton.innerHTML = 'üì± Installer l\'app KOP SUD';
installButton.style.cssText = `
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, #009900 0%, #006600 100%);
  color: white;
  border: none;
  padding: 15px 25px;
  border-radius: 50px;
  font-weight: bold;
  font-size: 1em;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0, 153, 0, 0.4);
  z-index: 9999;
  display: none;
  transition: all 0.3s ease;
  font-family: Arial, sans-serif;
`;

// Effet hover
installButton.addEventListener('mouseenter', () => {
  installButton.style.transform = 'translateY(-3px)';
  installButton.style.boxShadow = '0 6px 20px rgba(0, 153, 0, 0.5)';
});

installButton.addEventListener('mouseleave', () => {
  installButton.style.transform = 'translateY(0)';
  installButton.style.boxShadow = '0 4px 15px rgba(0, 153, 0, 0.4)';
});

document.body.appendChild(installButton);

// √âv√©nement beforeinstallprompt
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installButton.style.display = 'block';
  console.log('üí° Bouton d\'installation PWA affich√©');
});

// Clic sur le bouton d'installation
installButton.addEventListener('click', async () => {
  if (!deferredPrompt) {
    console.log('‚ùå Aucune demande d\'installation en attente');
    return;
  }
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    console.log('‚úÖ L\'utilisateur a accept√© l\'installation');
  } else {
    console.log('‚ùå L\'utilisateur a refus√© l\'installation');
  }
  
  deferredPrompt = null;
  installButton.style.display = 'none';
});

// √âv√©nement appinstalled
window.addEventListener('appinstalled', () => {
  console.log('üéâ PWA install√©e avec succ√®s !');
  installButton.style.display = 'none';
  deferredPrompt = null;
  alert('üéâ Application KOP SUD ASSE install√©e avec succ√®s !\n\nVous pouvez maintenant y acc√©der depuis votre √©cran d\'accueil.');
});

// D√©tecter si l'app est d√©j√† install√©e
if (window.matchMedia('(display-mode: standalone)').matches) {
  console.log('‚úÖ Application en mode standalone (d√©j√† install√©e)');
  installButton.style.display = 'none';
}
</script>
</body>
</html>